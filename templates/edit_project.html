<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Project</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/projects.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/projects-sub.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/add_project.css') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">

  <style>

        a:hover{
          color:var(--navy_color);
        }
       
    .editable-input, .editable-textarea {
      all: unset;
      font-family: inherit;
      font-size: inherit;
      font-weight: inherit;
      line-height: inherit;
      width: 100%;
      display: block;


    }

    .editable-input:focus,
    .editable-textarea:focus {
      outline: none;
      background-color: rgba(0, 0, 0, 0.05);

    }

    .image-upload-label {
      display: block;
      width: 100%;
      height: auto;
      cursor: pointer;
      background: #eee;
      text-align: center;
      padding: 2em;
      font-size: 1.2em;
      color: #888;
    }

    .image-upload-label:hover {
      background-color: var(--accent);
      color: #fff;
    }

    .project-img-container img {
      max-width: 100%;
      height: auto;
    }
      .floating-card {
    position: fixed;
    top: 200px;
    left: 50px;
    z-index: 9999;
    cursor: move;
    transition: all 0.3s ease;
  }
.card-item {
    pointer-events: auto;
    width: 25em;
    height: 30em;
    display: flex;
    flex-direction: column;
    background-color: var(--white);

  }
  .auto-resize {
    min-height: 44px; /* ~1 line */
    resize: none; /* Disable manual resize */
    overflow-y: hidden; /* Hide scrollbar */
}

.image-gallery-editor {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.image-editor-item {
    border: 1px solid #eee;
    padding: 10px;
    background: var(--white);
    border-radius: 5px;
}

.image-editor-item img {
    max-width: 100%;
    height: auto;
    display: block;
    margin-bottom: 10px;
}

.image-controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.image-controls select, 
.image-controls input {
    padding: 5px;
    font-size: 14px;
}

.set-primary {
    background-color: #4CAF50;
    color: var(--white);
}

.remove-image {
    background-color: #f44336;
    color: var(--white);
}

.hint {
    font-size: 0.9em;
    color: #666;
    font-style: italic;
}
.cover_image-label {
  transition: all 0.3s ease;
  font-size: 1.2em;
  text-align: center;
}

.cover_image-label:hover {
  background: rgba(0,0,0,0.5) !important;
}

.card-visual {
  display:flex;
  justify-content: center;
}
.cover-button{ 
  align-self: center;

}

.cover-button input[type="file"]{
  display:none;
}
.cover-button button{
    background-color: rgba(186, 185, 185, 0.482);
    border-radius:5px 5px;
    border:2px solid black;
    color:black;
    padding:0.7em 1em;
}

    .card-actions {
      position: absolute;
      z-index: 1;
      align-self: flex-end;
      background-color: var(--white);
      bottom: 10px;
      right: 10px;
      display: flex;
      gap: 20px;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 1.2em;
    }
        .card-actions i {
      cursor: pointer;
      font-size:1.2em;
    }

        .featured {
            color: var(--accent);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
    .plain_label { display: block; margin-top: 1.2em; font-weight: bold; }
    .plain_input[type="text"], .plain_input[type="date"], textarea {
      width: 100%;
      padding: 0.7em;
      margin-top: 0.3em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .plain_input[type="file"] { margin-top: 0.5em; }
    .admin_button{
    font-size:0.9em;
    background-color: var(--navy_color);
    border-radius:5px 5px;
    border:none;
    color:var(--white);
    padding:0.7em 1em;
}

    .admin_button:hover {
      background-color: var(--accent);
      transition-duration:0.4s;

    }
  </style>
</head>

<body>

    <button class="admin_button" id="toggleViewBtn"  style="
    position: fixed;
    top: 1em;
    left: 1em;
    z-index: 999;
    ">Plain View</button>

<main  id="styled-view">
    <form action="/admin/projects/{{ project.id }}/edit" method="POST" enctype="multipart/form-data">
      <section class="cover-section-2">
        <div class="cover-text-2">
          <p><a href="/">Home</a> ❯ <a href="/admin/projects">Projects</a></p>
          <h1><input name="title"style="text-transform: capitalize; " class="editable-input" value="{{ project.title }}"></h1>
        </div>
      </section>

      <section class="project-info-section">
        <div class="project-info-main">
          <div class="project-info-description">
            <h1><textarea name="subtitle" class="editable-textarea auto-resize "  
 placeholder="Project subtitle...">{{project.subtitle or ''}}</textarea></h1>
            <div class="project-info-description-p">
              <textarea name="description" class="editable-textarea auto-resize" 
 placeholder="Project description">{{ project.description }}</textarea>
            </div>



            <!-- Project Images Section (for main content) -->
            <div class="project-images-section">
                <h3>Project Images</h3>
                
                <!-- Existing Images -->
                <div class="image-gallery-editor">
                    {% for img in project.images %}
                    <div class="image-editor-item" data-id="{{ img.id }}">
                        <img src="{{ img.url }}">
                        <div class="image-controls">
                            <select name="image_layout_{{ img.id }}">
                                <option value="full-width" {% if img.layout_type=='full-width' %}selected{% endif %}>Full Width</option>
                                <option value="half-left" {% if img.layout_type=='half-left' %}selected{% endif %}>Half Left</option>
                                <option value="half-right" {% if img.layout_type=='half-right' %}selected{% endif %}>Half Right</option>
                                <option value="gallery" {% if img.layout_type=='gallery' %}selected{% endif %}>Gallery Style</option>
                            </select>
                            <input type="text" name="image_caption_{{ img.id }}" value="{{ img.caption }}" placeholder="Caption">
                            <input type="number" name="image_order_{{ img.id }}" value="{{ img.display_order }}" placeholder="Order">
                            <button type="button" class="set-primary" data-id="{{ img.id }}">Make Primary</button>
                            <button type="button" class="remove-image" data-id="{{ img.id }}">Remove</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- New Image Upload -->
                <div class="new-image-upload">
                    <h4>Add New Project Images</h4>
                    <input type="file" name="project_images" multiple accept="image/*">
                    <div class="layout-options">
                        <label>Default Layout for New Images:</label>
                        <select name="default_layout">
                            <option value="full-width">Full Width</option>
                            <option value="half-left">Half Left</option>
                            <option value="half-right">Half Right</option>
                            <option value="gallery">Gallery Style</option>
                        </select>
                    </div>
                </div>
            </div>
          </div>
        </div>

            
              <div class="project-info-panel">
                
                {% if project.service or True %}
                <div class="project-info-panel-div">
                  <h5><input name="service"  class= "editable-input" style="text-transform: uppercase;" placeholder="SERVICE" value="{{ project.service or '' }}"></h5>
                </div>
                {% endif %}

                {% if project.market or True %}
                <div class="project-info-panel-div">
                    <h4>MARKET</h4>
                    <div class="project-info-panel-div-p">
                    <input name="market" class= "editable-input" value="{{ project.market or '' }}">
                    </div>
                </div>
                {% endif %}
                <div class="project-info-panel-div">
                    <h4>LOCATION</h4>
                    <div class="project-info-panel-div-p">
                    <input name="location" class= "editable-input" value="{{ project.location or '' }}">
                    </div>
                </div>

                <div class="project-info-panel-div">
                    <h4>CLIENT</h4>
                    <div class="project-info-panel-div-p">
                    <input name="client" class= "editable-input" value="{{ project.client or '' }}">
                    </div>
                </div>

                <div class="project-info-panel-div">
                    <h4>COLLABORATION</h4>
                    <div class="project-info-panel-div-p">
                    <input name="collaboration" class= "editable-input" value="{{ project.collaboration or '' }}">
                    </div>
                </div>
                <div class="project-info-panel-div" style="display:none">
                  <h4>Project Date</h4>
                  <input name="date" type="date" placeholder="Date" class= "editable-input" value="{{project.date.strftime('%Y-%m-%d') if project.date else '' }}" />
                </div>
                <div class="project-info-panel-div">
                    <h4>COMPLETION DATE</h4>
                    <div class="project-info-panel-div-p">
                    <input name="completion_date" type="date" class= "editable-input" value="{{ project.completion_date.strftime('%Y-%m-%d') if project.completion_date else ''  }}">
                    </div>
                </div>

          <div style="margin-top: 2em;">
            <button type="button" onclick="addPanelField()">+ Add Info Section</button>
          </div>
        </div>
      </section>

        <input type="file" class="editable-input" name="cover_image" id="cover_image" accept="image/*" style="display:none">


      <div class="general" style="text-align:center; margin:2em;">
        <button type="submit">Save Changes</button>
      </div>
    </form>
    <!-- FLOATING PREVIEW CARD -->
<div id="floating-card" class="card-item hover-effect" style="position: fixed; top: 2em; right: 2em; z-index: 9999; cursor: move;">
 <!-- Cover Image Upload Area -->
  <div class="card-visual" id="preview-image" style="background-image: url('{{ project.cover_image_url }}'); position: relative;">
    {% if project.cover_image_url %} 
    <div class="cover-button general">
      <button>
        <label for="cover_image">change cover</label>
      <input type="file" class="editable-input" name="cover_image" id="cover_image" accept="image/*">
      </button>
    </div>
    {% else %}

    <div class="cover-button general">
      <button>
        <label for="cover_image">upload an image</label>
          <input type="file" class="editable-input" name="cover_image" id="cover_image" accept="image/*">
      </button>
    </div>
    {% endif %}
  </div>
  <div class="card-subtext">
<h5 style="display: flex; align-items: center; ">
  <input id="preview-market" value="{{ project.market }}" style="text-transform: uppercase;" placeholder="Market" class="editable-input" />
             {% if project.market and project.service %}  {% endif %}
  <input  id="preview-service" value="{{ project.service or '' }}" style="text-transform: uppercase;" placeholder="Service" class="editable-input" />
</h5>

<h2 style="text-transform: capitalize;"><input  id="preview-title" value="{{ project.title }}" class="editable-input"/></h2>

<h6 class="project-date">
  <input name="date" id="preview-date" type="date" placeholder="Date" class="editable-input" value="{{ project.date.strftime('%Y-%m-%d') if project.date else '' }}" />
</h6>
<div class="card-actions">
  <i class="feature-star {% if project.feature %}featured{% endif %}"                       
    onclick="toggleFeature('{{ project.id }}', this)">
    {% if project.feature %}★{% else %}☆{% endif %}
  </i>
</div>
  </div>

  <button id="collapse-btn" style="position:absolute; top:5px; right:5px;background-color: var(--white); border:none;width:1em;height:1em; font-size:2em; cursor:pointer;">-</button>
</div>
  </main>
  <form id="plain-view" action="/admin/projects/{{ project.id }}/edit" method="POST" enctype="multipart/form-data" style="display:none; max-width: 900px; margin: auto; padding: 3em; background: #f7f7f7; border-radius: 10px;">
  <h1>Edit Project (Plain View)</h1>

  <label class="plain_label" for="title">Project Title</label>
  <input class="plain_input" type="text" name="title" value="{{ project.title or '' }}" required>

  <label class="plain_label" for="subtitle">Subtitle</label>
  <input class="plain_input" type="text" name="subtitle" value="{{ project.subtitle or '' }}">

  <label class="plain_label" for="description">Description</label>
  <textarea class="plain_input" name="description" >{{ project.description or '' }}</textarea>

  <label class="plain_label" for="service">Service</label>
  <input  class="plain_input" type="text" name="service" value="{{ project.service or '' }}">

  <label class="plain_label" for="market">Market</label>
  <input class="plain_input" type="text" name="market" value="{{ project.market or '' }}">

  <label class="plain_label" for="location">Location</label>
  <input class="plain_input" type="text" name="location" value="{{ project.location or '' }}">

  <label class="plain_label" for="client">Client</label>
  <input class="plain_input" type="text" name="client" value="{{ project.client or '' }}">

  <label class="plain_label" for="collaboration">Collaboration</label>
  <input class="plain_input" type="text" name="collaboration" value="{{ project.collaboration or '' }}">

  <label class="plain_label" for="date">Project Date</label>
  <input class="plain_input" type="date" name="date" value="{{ project.date.strftime('%Y-%m-%d') if project.date else '' }}">

  <label class="plain_label" for="completion_date">Completion Date</label>
  <input class="plain_input" type="date" name="completion_date" value="{{ project.completion_date.strftime('%Y-%m-%d') if project.completion_date else '' }}">

  <label class="plain_label" for="cover_image">Change Cover Image</label>
  <input class="plain_input" type="file" name="cover_image" accept="image/*">

  <label class="plain_label" for="feature">
    Feature Project
  <input class="plain_input" type="checkbox" name="feature" value="true" {% if project.feature %}checked{% endif %}>
  </label>

  <button class="admin_button" style="margin-top:2em" type="submit">Save Changes</button>
</form>
<script>
  const toggleBtn = document.getElementById('toggleViewBtn');
  const styledView = document.getElementById('styled-view');
  const plainView = document.getElementById('plain-view');

  toggleBtn.addEventListener('click', () => {
    const isPlain = plainView.style.display === 'block';
    styledView.style.display = isPlain ? 'block' : 'none';
    plainView.style.display = isPlain ? 'none' : 'block';
    toggleBtn.textContent = isPlain ? 'Plain View' : 'Styled View';
  });
</script>


  <script>
  function addPanelField() {
    const panel = document.querySelector('.project-info-panel');
    
    const fieldWrapper = document.createElement('div');
    fieldWrapper.className = 'project-info-panel-div';

    const heading = prompt("Enter field label (e.g., ARCHITECT, SUPERVISOR):");
    const name = heading.toLowerCase().replace(/\s+/g, "_"); // e.g., "Completion Date" -> "completion_date"

    if (!heading) return;

    fieldWrapper.innerHTML = `
      <h3>${heading}</h3>
      <div class="project-info-panel-div-p">
        <input name="${name}" class="editable-input" placeholder="${heading}">
        <button type="button" onclick="this.closest('.project-info-panel-div').remove()">Remove</button>
      </div>
    `;
    
    // Insert before the "+ Add Info Section" button container
    const addBtnWrapper = panel.querySelector('div[style*="margin-top"]');
    panel.insertBefore(fieldWrapper, addBtnWrapper);
  }
</script>
<script>
// --- Three-way input sync for text/date fields ---
function syncTriple(fieldName) {
  const styled = document.querySelector(`#styled-view [name="${fieldName}"]`);
  const plain = document.querySelector(`#plain-view [name="${fieldName}"]`);
  const preview = document.getElementById(`preview-${fieldName}`);

  const updateAll = (sourceEl) => {
    const val = sourceEl.value;

    [styled, plain, preview].forEach(el => {
      if (el && el !== sourceEl) {
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.value = val;
        } else {
          el.textContent = val;
        }
      }
    });
  };

  [styled, plain, preview].forEach(el => {
    if (el) el.addEventListener('input', () => updateAll(el));
  });

  // Init values
  if (styled && plain) plain.value = styled.value;
  if (styled && preview) {
    if (preview.tagName === 'INPUT') preview.value = styled.value;
    else preview.textContent = styled.value;
  }
}

// Sync fields
[
  'title', 'subtitle', 'description',
  'service', 'market', 'location',
  'client', 'collaboration', 'date',
  'completion_date'
].forEach(syncTriple);
</script>

<script>
// --- Cover image sync (live preview) ---
const styledCover = document.querySelector(`#styled-view input[name="cover_image"]`);
const plainCover = document.querySelector(`#plain-view input[name="cover_image"]`);
const previewImage = document.getElementById('preview-image');

function updateCoverImagePreview(file) {
  const reader = new FileReader();
  reader.onload = e => {
    previewImage.style.backgroundImage = `url('${e.target.result}')`;
  };
  reader.readAsDataURL(file);
}

function syncCoverImage(input, source) {
  input.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Update preview
    updateCoverImagePreview(file);

    // Update other input if needed
    const other = input === styledCover ? plainCover : styledCover;
    if (other) other.files = e.target.files;
  });
}

if (styledCover) syncCoverImage(styledCover);
if (plainCover) syncCoverImage(plainCover);
</script>

<script>
// --- Feature checkbox sync ---
const styledFeature = document.querySelector('#styled-view input[name="feature"]');
const plainFeature = document.querySelector('#plain-view input[name="feature"]');
const previewStar = document.querySelector('.feature-star');

function setFeatureState(checked) {
  if (styledFeature) styledFeature.checked = checked;
  if (plainFeature) plainFeature.checked = checked;

  if (previewStar) {
    previewStar.classList.toggle('featured', checked);
    previewStar.textContent = checked ? '★' : '☆';
  }
}

// Checkbox changes
if (styledFeature) styledFeature.addEventListener('change', () => setFeatureState(styledFeature.checked));
if (plainFeature) plainFeature.addEventListener('change', () => setFeatureState(plainFeature.checked));

// Preview star toggle
if (previewStar) {
  previewStar.addEventListener('click', () => {
    const newState = !previewStar.classList.contains('featured');
    setFeatureState(newState);
  });
}
</script>



<script>
// Make the floating card draggable
const floatingCard = document.getElementById("floating-card");
let isDragging = false, offsetX = 0, offsetY = 0;

floatingCard.addEventListener("mousedown", e => {
  isDragging = true;
  offsetX = e.clientX - floatingCard.getBoundingClientRect().left;
  offsetY = e.clientY - floatingCard.getBoundingClientRect().top;
});

document.addEventListener("mousemove", e => {
  if (isDragging) {
    floatingCard.style.left = `${e.clientX - offsetX}px`;
    floatingCard.style.top = `${e.clientY - offsetY}px`;
    floatingCard.style.bottom = 'unset';
    floatingCard.style.right = 'unset';
  }
});

document.addEventListener("mouseup", () => isDragging = false);

// Collapse functionality
const collapseBtn = document.getElementById("collapse-btn");
let collapsed = false;
collapseBtn.addEventListener("click", () => {
  collapsed = !collapsed;
  floatingCard.style.height = collapsed ? "4em" : "30em";
  floatingCard.querySelector(".card-subtext").style.display = collapsed ? "none" : "flex";
  floatingCard.querySelector(".card-visual").style.height = collapsed ? "100%" : "100%";
  collapseBtn.textContent = collapsed ? "+" : "-";
});

</script>
<script>
  function resizeTextarea(textarea) {
    textarea.style.height = 'auto'; // Reset height
    textarea.style.height = `${textarea.scrollHeight}px`; // Set to content height
}

// Apply on page load AND on input
document.addEventListener("DOMContentLoaded", () => {
    const textareas = document.querySelectorAll('.auto-resize');
    
    textareas.forEach(ta => {
        // Initialize on load
        resizeTextarea(ta);
        
        // Update while typing
        ta.addEventListener('input', () => resizeTextarea(ta));
    });
}); 
</script>
<script>
  // Make images sortable
$(function() {
    $(".image-gallery-editor").sortable({
        update: function(event, ui) {
            // Update order numbers when dragged
            $('.image-editor-item').each(function(index) {
                $(this).find('input[type="number"]').val(index + 1);
            });
        }
    });
    
    // Set primary image
    $('.set-primary').click(function() {
        const imgId = $(this).data('id');
        $('.set-primary').text('Make Primary');
        $(this).text('✓ Primary');
        $('input[name="primary_image"]').val(imgId);
    });
    
    // Remove image
    $('.remove-image').click(function() {
        if(confirm('Are you sure you want to remove this image?')) {
            const imgId = $(this).data('id');
            $(this).closest('.image-editor-item').remove();
            // Add to hidden field for deletion on server
            $('<input>').attr({
                type: 'hidden',
                name: 'deleted_images[]',
                value: imgId
            }).appendTo('form');
        }
    });
    
    // Preview image before upload
    $('input[name="project_images"]').change(function(e) {
        const files = e.target.files;
        for(let i = 0; i < files.length; i++) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = $('<div class="image-editor-item new-image"><img src="' + e.target.result + '"><div class="image-controls">' +
                    '<select name="new_image_layout[]"><option value="full-width">Full Width</option>' +
                    '<option value="half-left">Half Left</option><option value="half-right">Half Right</option>' +
                    '<option value="gallery">Gallery Style</option></select>' +
                    '<input type="text" name="new_image_caption[]" placeholder="Caption">' +
                    '<input type="number" name="new_image_order[]" value="' + ($('.image-editor-item').length + 1) + '" placeholder="Order">' +
                    '<button type="button" class="remove-new-image">Remove</button></div></div>');
                $('.image-gallery-editor').append(preview);
            }
            reader.readAsDataURL(files[i]);
        }
    });
    
    // Remove new images before upload
    $(document).on('click', '.remove-new-image', function() {
        $(this).closest('.image-editor-item').remove();
    });
});
</script>
<script>
document.getElementById('cover_image').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const preview = document.getElementById('preview-image');
      preview.style.backgroundImage = `url('${e.target.result}')`;

      const label = preview.querySelector('.cover_image-label');
      if (label) {
        label.style.display = 'none';
      }
    }
    reader.readAsDataURL(file);
  }
});


</script>
<script>
  function toggleFeature(projectId, starElement) {
    const isCurrentlyFeatured = starElement.textContent === '★';
    const action = isCurrentlyFeatured ? 'unfeature' : 'feature';
    
    starElement.style.pointerEvents = 'none';  // prevent double click
  
    fetch(`/admin/projects/${projectId}/feature`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ action: action })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            starElement.textContent = action === 'feature' ? '★' : '☆';
            starElement.classList.toggle('featured', action === 'feature');
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        alert('Error: ' + err.message);
    })
    .finally(() => {
        starElement.style.pointerEvents = 'auto';
    });
}
      
</script>

</body>
</html>
